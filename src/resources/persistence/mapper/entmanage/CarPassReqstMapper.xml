<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.skshieldus.esecurity.repository.entmanage.CarPassReqstRepository">

	<select id="selectCarPassReqstList" parameterType="hashMap" resultType="CamelHashMap">
		SELECT A.*
			FROM
				(
					SELECT ROW_NUMBER() OVER(ORDER BY VSTCAR_APPL_NO DESC) as ROW_NUM
					, T.*
						FROM
							(
								SELECT
									A.VSTCAR_APPL_NO
									,TO_CHAR(A.CRT_DTM, 'YYYY.MM.DD') as CRT_DTM
		        					,A.CRT_BY
		        					,FN_GET_EMP_NM(A.CRT_BY) as CRT_NM
									,(
		            					SUBSTR(A.IO_STRT_DT, 1,4) || '-' || SUBSTR(A.IO_STRT_DT, 5,2) || '-' || SUBSTR(A.IO_STRT_DT, 7,2) || ' ~ ' ||
		            					SUBSTR(A.IO_END_DT, 1,4) || '-' || SUBSTR(A.IO_END_DT, 5,2) || '-' || SUBSTR(A.IO_END_DT, 7,2)
		        					) as IO_DT
									,A.IO_STRT_DT
									,A.IO_END_DT
								/*	,A.VST_PLC */
									,FN_GET_VST_PARK_LOT_LIST(A.VST_PLC,A.SUM_VST_PLC_GATE,'CODE')  AS VST_PLC
								/*	,(SELECT DETL_NM FROM CO_CODE_D WHERE GRP_CD in ('A028', 'A029') AND DETL_CD = A.VST_PLC) as VST_PLC_NM
								청주 차량 관련 방문 주차장 코드화 관련 변경 20190401 HSK */
		                            , FN_GET_VST_PARK_LOT_LIST( A.VST_PLC, A.SUM_VST_PLC_GATE,'NAME')  AS VST_PLC_NM
									,A.VST_OBJ
									,(SELECT DETL_NM FROM CO_CODE_D WHERE GRP_CD = 'A013' AND DETL_CD = A.VST_OBJ) as VST_OBJ_NM
									,A.VIP_YN
									,A.COMP_ID
									,FN_GET_CONAME('COMP','', A.COMP_ID) as COMP_NM
									,A.DEPT_ID
									,FN_GET_CONAME('DEPT', A.DEPT_ID, A.COMP_ID) as DEPT_NM
									,A.JW_ID
									,FN_GET_CONAME('JW', A.JW_ID,'') as JW_NM
									,A.EMP_ID
									,FN_GET_EMP_NM(A.EMP_ID) as EMP_NM
									,AD.DOC_ID
									,NVL(AD.APPR_STAT, 'N') as APPR_STAT
		                	        ,NVL(AD.APPR_RESULT, 'N') as APPR_RESULT
		            	            ,CASE
		        	                    WHEN AD.APPR_STAT = '0' THEN '대기'
		    	                        WHEN AD.APPR_STAT = '10' THEN '진행'
			                            WHEN AD.APPR_STAT = '20' THEN '완료'
			                            WHEN NVL(AD.APPR_STAT, 'N') = 'N' THEN '임시보관'
		                    	     END as APPR_STAT_NM
		                	        ,CASE
		            	                WHEN AD.APPR_RESULT = '0' THEN '검토중'
		        	                    WHEN AD.APPR_RESULT = '1' THEN '승인'
		    	                        WHEN AD.APPR_RESULT = '2' THEN '반려'
		    	                        WHEN NVL(AD.APPR_RESULT, 'N') = 'N' THEN '임시보관'
			                         END as APPR_RESULT_NM
								    FROM
								IO_VSTCAR_M A
									,AP_DOC AD
								WHERE 1=1
									AND NVL(A.DEL_YN, 'N') = 'N'
									AND A.DOC_ID = AD.DOC_ID(+)
								<if	test='not @org.springframework.util.StringUtils@isEmpty(vstComp) and !"".equals(vstComp)'>
				                	AND A.VST_COMP = #{vstComp}
			                	</if>
								<if	test='not @org.springframework.util.StringUtils@isEmpty(searchType) and "1".equals(searchType)'>
									AND A.EMP_ID = #{searchEmpId}
								</if>
								<if	test='not @org.springframework.util.StringUtils@isEmpty(searchType) and "2".equals(searchType)'>
									AND AD.EMP_ID = #{searchEmpId}
								</if>
								<if	test="not @org.springframework.util.StringUtils@isEmpty(searchStrtDt) and
									  not @org.springframework.util.StringUtils@isEmpty(searchEndDt)">
   									AND (IO_STRT_DT BETWEEN REPLACE(#{searchStrtDt}, '-', '') AND REPLACE(#{searchEndDt}, '-', '')
									    OR IO_END_DT BETWEEN REPLACE(#{searchStrtDt}, '-', '') AND REPLACE(#{searchEndDt}, '-', ''))
								</if>
								<if test="not @org.springframework.util.StringUtils@isEmpty(searchCarNo)">
						 			AND  A.VSTCAR_APPL_NO IN (SELECT VSTCAR_APPL_NO FROM IO_VSTCAR_D WHERE VSTCAR_APPL_NO = A.VSTCAR_APPL_NO AND CAR_NO LIKE '%' || #{searchCarNo} || '%')
								</if>
									/* 진행상태 */
								<if test="not @org.springframework.util.StringUtils@isEmpty(searchApplStat)">
						 			<if test='"10".equals(searchApplStat)'>
						 			/* 검토중 */
									AND AD.APPR_STAT = #{searchApplStat}
						 			</if>
						 			<if test='"20".equals(searchApplStat)'>
						 			/* 처리완료 */
									AND AD.APPR_STAT = #{searchApplStat}
						 			</if>
						 			<if test='"1".equals(searchApplStat)'>
						 			/* 승인 */
									AND AD.APPR_RESULT = #{searchApplStat}
						 			</if>
						 			<if test='"2".equals(searchApplStat)'>
						 			/* 반려 */
									AND AD.APPR_RESULT = #{searchApplStat}
						 			</if>
								</if>
							) T
							WHERE 1 = 1
				            <if test="not @org.springframework.util.StringUtils@isEmpty(searchGateId)">
				            	AND
				            	<foreach collection="searchGateId" item="item" separator="AND" index="index">
					 				VST_PLC LIKE '%'||#{item}||'%'
				    			</foreach>
							</if>
		 				) A
	</select>

	<select id="selectCarPassReqstView" parameterType="hashMap" resultType="CamelHashMap">
		SELECT
		A.VSTCAR_APPL_NO
		,TO_CHAR(A.CRT_DTM, 'YYYY.MM.DD') as CRT_DTM
		,A.CRT_BY
		,FN_GET_IO_EMP_NM(A.CRT_BY) as CRT_NM
		,(
		SUBSTR(A.IO_STRT_DT, 1,4) || '.' || SUBSTR(A.IO_STRT_DT, 5,2) || '.' || SUBSTR(A.IO_STRT_DT, 7,2) || '~' ||
		SUBSTR(A.IO_END_DT, 1,4) || '.' || SUBSTR(A.IO_END_DT, 5,2) || '.' || SUBSTR(A.IO_END_DT, 7,2)
		) as IO_DT
		,(SUBSTR(A.IO_STRT_DT, 1, 4) || '-' || SUBSTR(A.IO_STRT_DT, 5, 2) || '-' || SUBSTR(A.IO_STRT_DT, 7, 2)) as IO_STRT_DT
		,(SUBSTR(A.IO_END_DT, 1, 4) || '-' || SUBSTR(A.IO_END_DT, 5, 2) || '-' || SUBSTR(A.IO_END_DT, 7, 2)) as IO_END_DT
		,A.VST_PLC
		/* ,(SELECT DETL_NM FROM CO_CODE_D WHERE GRP_CD in ('A028', 'A029', 'A041') AND DETL_CD = A.VST_PLC) as VST_PLC_NM */
		,FN_GET_VST_PLC_NAME_LIST(A.VST_PLC) AS VST_PLC_NM
		,A.VST_OBJ
		,CASE WHEN (SELECT DIV_CD FROM CO_EMP CC WHERE EMP_ID =A.EMP_ID ) ='CP'
		THEN FN_GET_CODE('A040',A.VST_OBJ,'')
		WHEN (SELECT DIV_CD FROM CO_EMP WHERE EMP_ID =A.EMP_ID ) !='CP'
		THEN FN_GET_CODE('A013',A.VST_OBJ,'')
		END AS VST_OBJ_NM
		,A.VST_RSN
		,A.VIP_YN
		,A.COMP_ID
		,FN_GET_CONAME('COMP','', A.COMP_ID) as COMP_NM
		,A.DEPT_ID
		,FN_GET_CONAME('DEPT', A.DEPT_ID, A.COMP_ID) as DEPT_NM
		,A.JW_ID
		,FN_GET_CONAME('JW', A.JW_ID,'') as JW_NM
		,A.EMP_ID
		,(SELECT EMAIL FROM CO_EMP WHERE EMP_ID = A.EMP_ID) as EMP_EMAIL
		,FN_GET_EMP_NM(A.EMP_ID) as EMP_NM
		,FN_GET_EMP_NM (A.EMP_ID) || FN_GET_CONAME ('JW', A.JW_ID, '') AS EMP_JW_NM
		,A.APPL_STAT
		,(SELECT DIV_CD FROM CO_EMP WHERE EMP_ID = A.EMP_ID) AS DIV_CD
		,(SELECT JOBLOCAT FROM CO_EMP WHERE EMP_ID = A.EMP_ID) AS DIV_NM
		,(SELECT TEL_NO1 FROM CO_EMP WHERE EMP_ID = A.EMP_ID) AS TEL_NO1
		,(SELECT TEL_NO2 FROM CO_EMP WHERE EMP_ID = A.EMP_ID) AS TEL_NO2
		FROM
		IO_VSTCAR_M A
		WHERE 1=1
		<if test="not @org.springframework.util.StringUtils@isEmpty(vstcarApplNo)">
			AND A.VSTCAR_APPL_NO = #{vstcarApplNo}
		</if>
		<if test="not @org.springframework.util.StringUtils@isEmpty(docId)">
			AND A.DOC_ID = #{docId}
		</if>
	</select>

	<select id="selectCarPassReqstUserList" parameterType="hashMap" resultType="CamelHashMap">
		SELECT IO_EMP_ID,IO_COMP_ID,EMP_NM,COMP_NM,CAR_KND,CAR_NO,TEL_NO
		  FROM (SELECT ROW_NUMBER() OVER (ORDER BY IO_EMP_ID) as ROW_NUM
					, T.*
						FROM
							(
								SELECT A.IO_EMP_ID,
								CASE WHEN A.COMP_GBN='A0101001' THEN FN_GET_EMP_NM(A.IO_EMP_ID)
								ELSE (SELECT EMP_NM FROM IO_EMP WHERE IO_EMP_ID = A.IO_EMP_ID)
								END EMP_NM,
								A.IO_COMP_ID,
								CASE WHEN A.COMP_GBN='A0101001' THEN FN_GET_COMP_NM(A.IO_COMP_ID)
								ELSE (SELECT COMP_KO_NM FROM IO_COMP WHERE IO_COMP_ID = A.IO_COMP_ID)
								END COMP_NM,
								A.CAR_KND,A.CAR_NO,
								CASE	WHEN LENGTHB(A.TEL_NO) = 10
								THEN SUBSTR(A.TEL_NO, 1,3) || '-' || SUBSTR(A.TEL_NO, 4,3) || '-'  || SUBSTR(A.TEL_NO, 7,4)
								WHEN LENGTHB(A.TEL_NO) = 11	THEN
								SUBSTR(A.TEL_NO, 1,3) || '-' || SUBSTR(A.TEL_NO, 4,4) || '-'  || SUBSTR(A.TEL_NO, 8,4)
								ELSE TEL_NO
								END AS TEL_NO
								FROM (SELECT DISTINCT IO_EMP_ID, IO_COMP_ID,COMP_GBN, CAR_KND, CAR_NO, TEL_NO
								FROM IO_VSTCAR_D
								WHERE 1=1
								<if test="not @org.springframework.util.StringUtils@isEmpty(vstcarApplNo)">
									AND VSTCAR_APPL_NO = #{vstcarApplNo}
								</if>
								<if test="not @org.springframework.util.StringUtils@isEmpty(docId)">
									AND VSTCAR_APPL_NO = (SELECT VSTCAR_APPL_NO FROM IO_VSTCAR_M WHERE DOC_ID = (SELECT DOC_ID FROM AP_DOC WHERE DOC_ID =#{docId}))
								</if>
								) A
						) T
		) A
	</select>

	<select id="selectIoVstCarInfoForICSpms" parameterType="hashMap" resultType="SendSpmsDTO">
		SELECT DISTINCT
	        '' AS DIVISION
	        ,'2' AS MEMBERTYPE /* 방문객 */
	    	, IVD.VSTCAR_APPL_NO /* */
	    	,IVD.CAR_NO 				as VehicleNumber    /* VehicleNumber: 차량번호 */
	    	,SUBSTRB(IVD.CAR_KND,1,25) 	as VehicleName		/* Vehicle_kind : 차량종류 */
		    ,IVM.IO_STRT_DT 				as EnterDateTime 	/* EnterDateTime  : 예약시작일시 */
		    ,IVM.IO_END_DT 				as NoEntryDatetime 	/* NoEntryDatetime : 예약종료일시 */
		    ,SUBSTRB(FN_GET_CODE('A013', IVM.VST_OBJ, ''),1,20) as VisitPurpose  /* VisitPurpose  : 방문목적 */
		    ,SUBSTRB(FN_GET_DEPT_NM(IVM.DEPT_ID),1,30) ||'('||SUBSTRB(FN_GET_EMP_NM(IVM.EMP_ID),1,12)||' ' || SUBSTRB(FN_GET_JW_NM(IVM.JW_ID),1,8) ||')'  as ApproverName  /* ApproverName  : 부서명(신청자명) */
		    ,SUBSTRB((SELECT EMP_NM FROM IO_EMP WHERE IO_EMP_ID = IVD.IO_EMP_ID),1,20) as VisitorName  /* VisitorName   : 운전자 */
		    ,SUBSTRB(FN_GET_IO_COMP_KO_NM(IVD.IO_COMP_ID),1,100)  as AffiliatedCompany /* AffiliatedCompany  : 업체명 */
		    ,IVD.TEL_NO 				AS ContactNumber 	/*방문객휴대전화*/
		    ,IVM.VST_PLC 		AS Destination  /* SUBSTRB(FN_GET_CODE('A028', IVM.VST_PLC, ''), 1,50) 	AS Destination	*/ 	/* Destination  : 청주만 방문장소 */
		    ,'' AS DEPTNAME
            ,'' AS LOCATION
            ,'' AS BIRTHDAY
		    ,'' AS note
		    ,IVD.IO_EMP_ID as SECURITYID
            ,FN_GET_IDCARD_ID(IVD.IO_EMP_ID) AS UNIONNUMBER
            ,SUM_VST_PLC_GATE AS SumVstPlcGate
		 FROM IO_VSTCAR_D IVD, IO_VSTCAR_M IVM
		 WHERE 1=1
	   		AND IVD.VSTCAR_APPL_NO = IVM.VSTCAR_APPL_NO
		   	AND IVM.VSTCAR_APPL_NO = #{lid}
	</select>

	<select id="selectIoVstCarInfoForCJSpms" parameterType="hashMap" resultType="SendSpmsDTO">
		SELECT DISTINCT
	        IVD.VSTCAR_APPL_NO /* */
	        ,'7' AS DIVISION /*VIP*/
	        ,'85' AS MEMBERTYPE /* 85 : SKHYnix */
	        ,IVD.CAR_NO         as VehicleNumber    /* VehicleNumber: 차량번호 */
	        ,SUBSTRB(IVD.CAR_KND,1,25)  as VehicleName    /* Vehicle_kind : 차량종류 */

	        ,IVM.IO_STRT_DT         as EnterDateTime  /* EnterDateTime  : 예약시작일시 */
	        ,IVM.IO_END_DT        as NoEntryDatetime  /* NoEntryDatetime : 예약종료일시 */
	        ,SUBSTRB(FN_GET_CODE('A013', IVM.VST_OBJ, ''),1,20) as VisitPurpose  /* VisitPurpose  : 방문목적 */

	        ,SUBSTRB(FN_GET_DEPT_NM(IVM.DEPT_ID),1,100) ||'('||SUBSTRB(FN_GET_EMP_NM(IVM.EMP_ID),1,30)||' ' || SUBSTRB(FN_GET_JW_NM(IVM.JW_ID),1,15) ||')'  as ApproverName  /* ApproverName  : 부서명(신청자명) */
	        ,SUBSTRB((SELECT EMP_NM FROM IO_EMP WHERE IO_EMP_ID = IVD.IO_EMP_ID),1,20) as VisitorName  /* VisitorName   : 운전자 */
	        ,SUBSTRB(FN_GET_IO_COMP_KO_NM(IVD.IO_COMP_ID),1,200)  as AffiliatedCompany /* AffiliatedCompany  : 업체명 */
	        ,'' as DeptName
	        ,IVD.TEL_NO         AS ContactNumber  /*방문객휴대전화*/
	        ,IVM.VST_PLC    AS Destination  /* SUBSTRB(FN_GET_CODE('A028', IVM.VST_PLC, ''), 1,50)  AS Destination  */  /* Destination  : 청주만 방문장소 */
	        ,'' as location
	        ,'' AS Birthday
	        ,'' AS note
	        ,IVD.IO_EMP_ID as SECURITYID
	        ,FN_GET_IDCARD_ID(IVD.IO_EMP_ID) AS UNIONNUMBER
	        ,IVM.SUM_VST_PLC_GATE AS SumVstPlcGate
	     FROM IO_VSTCAR_D IVD, IO_VSTCAR_M IVM
	     WHERE 1=1
	        AND IVD.VSTCAR_APPL_NO = IVM.VSTCAR_APPL_NO
	        AND IVM.VSTCAR_APPL_NO = #{lid}
	</select>

	<select id="selectCarPassListForSMS" parameterType="hashMap" resultType="CamelHashMap">
		SELECT DISTINCT
		    FN_GET_IO_EMP_NM(ID.IO_EMP_ID) as RECEIVE_EMP_NM
		    , ID.TEL_NO AS SMS_NO
		    , SUBSTR(IO_STRT_DT,1,4) || '-' || SUBSTR(IO_STRT_DT, 5,2) || '-' || SUBSTR(IO_STRT_DT, 7,2) ||
		        ' ~ '
		      || SUBSTR(IO_END_DT,1,4) || '-' || SUBSTR(IO_END_DT, 5,2) || '-' || SUBSTR(IO_END_DT, 7,2)  as VISIT_DAY
		    , REPLACE(FN_GET_EMP_TEL_NO('TEL_NO1', AP.EMP_ID), '-', '') as CALLBACK_NO
		    , AP.EMP_ID AS SEND_EMP_ID
		    , FN_GET_DIV_NM(CD.DEPT_ID) AS COMP_NM
		    /* , (SELECT DETL_NM FROM CO_CODE_D WHERE GRP_CD in ('A028', 'A029') AND DETL_CD = IM.VST_PLC)  AS PARKING_NM */
		     , FN_GET_VST_PARK_LOT_LIST( IM.VST_PLC,IM.SUM_VST_PLC_GATE,'NAME')  AS PARKING_NM
			, IM.COMP_ID AS COMP_ID
		FROM
		    IO_VSTCAR_D ID
		    , IO_VSTCAR_M IM
		    LEFT OUTER JOIN
		    (SELECT MAX(AP_SEQ) as MAX_SEQ, DOC_ID FROM AP_APPR GROUP BY DOC_ID) AD ON ( IM.DOC_ID = AD.DOC_ID)
		    LEFT OUTER JOIN
		    (SELECT AP_SEQ, DOC_ID, EMP_ID FROM AP_APPR) AP ON (AP.AP_SEQ = AD.MAX_SEQ AND AP.DOC_ID = IM.DOC_ID)
		    , CO_DEPT CD
		WHERE 1=1
		    AND ID.VSTCAR_APPL_NO = IM.VSTCAR_APPL_NO
		    AND IM.DEPT_ID = CD.DEPT_ID
		    AND IM.VSTCAR_APPL_NO = #{lid}
	</select>

	<update id="updateCarPassReqstDocId" parameterType="hashMap">
		UPDATE IO_VSTCAR_M
		   SET DOC_ID  = #{docId}
			  ,MOD_BY  = #{modBy}
			  ,MOD_DTM = SYSDATE
		 WHERE VSTCAR_APPL_NO = #{vstcarApplNo}
	</update>

	<update id="updateCarPassReqstApplWork" parameterType="hashMap">
		UPDATE IO_VSTCAR_M
        SET
            MOD_BY = #{empId},
            MOD_DTM = SYSDATE
        WHERE VSTCAR_APPL_NO = #{vstcarApplNo}
	</update>

	<select id="selectCarPassReqstNewSeq" parameterType="hashMap" resultType="Integer">
		<if	test='not @org.springframework.util.StringUtils@isEmpty(schemaNm) and "CAR_PASS_VSIT".equals(schemaNm)'>
			SELECT SEQ_IO_VSTCAR_NO.NEXTVAL AS VSTCAR_APPL_NO FROM DUAL
		</if>
	</select>

	<insert id="insertCarPassReqst" parameterType="hashMap">
	    INSERT
		  INTO
		IO_VSTCAR_M
		(
			VSTCAR_APPL_NO
		    , IO_STRT_DT
    		, IO_END_DT
    		, VST_COMP
		    , VST_PLC
		    , VST_OBJ
		    , VST_RSN
		    , VIP_YN
		    , APPL_STAT
		    , COMP_ID
		    , DEPT_ID
		    , JW_ID
		    , EMP_ID
		    , DEL_YN
		    , AC_IP
		    , CRT_BY
		    , CRT_DTM
		    , MOD_BY
		    , MOD_DTM
		    , SUM_VST_PLC_GATE
		)
		VALUES
		(
			#{vstcarApplNo}
		    , REPLACE(#{ioStrtDt} 	, '-', '')
    		, REPLACE(#{ioEndDt} 	, '-', '')
    		, #{vstCompId}
		    , #{gateId}
		    , #{vstObj}
		    , #{vstRsn}
		    , CASE
		    	WHEN #{vstObj} = 'A0271001'
		    		THEN 'Y'
		    	ELSE
		    		'N'
		    	END
		    , 'N'
		    , #{compId}
		    , #{deptId}
		    , #{jwId}
		    , #{empId}
		    , 'N'
		    , #{acIp}
		    , #{crtBy}
		    , SYSDATE
		    , #{modBy}
		    , SYSDATE
		    , #{sumVstPlcGate}
	    )
	</insert>

	<insert id="insertCarPassReqstUser" parameterType="hashMap">
	    INSERT
		  INTO
		IO_VSTCAR_D
		(
			VSTCAR_APPL_NO
			, IO_COMP_ID
			, IO_EMP_ID
			, IO_DT
			, CAR_KND
			, CAR_NO
			, TEL_NO
			, DEL_YN
			, AC_IP
			, CRT_BY
			, CRT_DTM
			, MOD_BY
			, MOD_DTM
		)
		VALUES
		(
			#{vstcarApplNo}
			, #{ioCompId}
			, #{ioEmpId}
			, #{ioDt}
			, #{carKnd}
			, #{carNo}
			, #{hpNo}
			, 'N'
			, #{acIp}
			, #{crtBy}
			, SYSDATE
			, #{modBy}
			, SYSDATE
		)
	</insert>

	<select id="selectCarPassQuotaCheck" parameterType="hashMap" resultType="CamelHashMap">
		SELECT
		    (SUBSTR(#{ioDt},1,4) || '-' ||SUBSTR(#{ioDt},5,2) || '-' ||SUBSTR(#{ioDt}, 7)) AS IO_DT
		    ,TODAY_WAIT_CNT
		    ,(TO_NUMBER(CAR_QTA) - (TO_NUMBER(TODAY_CNT)+TO_NUMBER(TODAY_WAIT_CNT))) AS TODAY_CNT
		    ,CAR_QTA
		  FROM (SELECT ROW_NUMBER() OVER(
		                 ORDER BY DEPT_DIV_ID ASC ) AS ROW_NUM,
		               TB.*
		          FROM (SELECT DISTINCT IC.COMP_ID ,
		                       IC.DEPT_DIV_ID ,
		                       IC.DEPT_DIV_NM ,
		                       IC.CAR_QTA ,
		                       (SELECT CC.COMP_NM
		                          FROM CO_COMP CC
		                         WHERE IC.COMP_ID = CC.COMP_ID) AS COMP_NM ,
		                       IC.DEL_YN ,
		                       FN_GET_TODAYCAR_CNT(#{ioDt},CD.DEPT_ID,'20','1') AS TODAY_CNT ,
		                       FN_GET_TODAYCAR_CNT(#{ioDt},CD.DEPT_ID,'10','0') AS TODAY_WAIT_CNT ,
		                       (SELECT SUM(CAR_QTA)
		                          FROM IO_CARQUOTA
		                         WHERE COMP_ID = IC.COMP_ID
		                           AND DEL_YN = 'N') AS TOTAL
		                  FROM IO_CARQUOTA IC ,
		                       (SELECT DEPT_ID
						          FROM CO_DEPT X
						         START WITH X.DEPT_ID = #{deptId}
						       CONNECT BY PRIOR X.UPDEPT_ID = X.DEPT_ID) CD
		                 WHERE 1=1
		                   AND CD.DEPT_ID = IC.DEPT_DIV_ID
		                   AND NVL(IC.DEL_YN, 'Y') != 'Y'
		                ) TB
		            ) A
	</select>

	<!-- <select id="selectCarPassQuotaCheckBeforeSave" parameterType="hashMap" resultType="CamelHashMap">
		SELECT COUNT(TODAY_CNT) AS CHECK_CNT FROM (
		  SELECT
		    (SUBSTR(#{ioDt},1,4) || '-' ||SUBSTR(#{ioDt},5,2) || '-' ||SUBSTR(#{ioDt}, 7)) AS IO_DT
		    ,TODAY_WAIT_CNT
		    ,(TO_NUMBER(CAR_QTA) - (TO_NUMBER(TODAY_CNT)+TO_NUMBER(TODAY_WAIT_CNT))) AS TODAY_CNT
		    ,CAR_QTA
		  FROM (SELECT ROW_NUMBER() OVER(
				 ORDER BY DEPT_DIV_ID ASC ) AS ROW_NUM,
			       TB.*
			  FROM (SELECT DISTINCT IC.COMP_ID ,
				       IC.DEPT_DIV_ID ,
				       IC.DEPT_DIV_NM ,
				       IC.CAR_QTA ,
				       (SELECT CC.COMP_NM
					  FROM CO_COMP CC
					 WHERE IC.COMP_ID = CC.COMP_ID) AS COMP_NM ,
				       IC.DEL_YN ,
				       (SELECT COUNT(*)
					  FROM IO_VSTCAR_M IVM ,
					       IO_VSTCAR_D IVD ,
					       AP_DOC AD
					 WHERE 1=1
					   AND IVM.VSTCAR_APPL_NO = IVD.VSTCAR_APPL_NO
					   AND AD.DOC_ID = IVM.DOC_ID
					   AND IVM.COMP_ID = '1101000001'
					   AND IVM.VIP_YN != 'Y'
					   AND IO_DT = REPLACE(REPLACE(#{ioDt}, '-', ''), ';', '')
					   AND AD.APPR_STAT = '20'
					   AND AD.APPR_RESULT = '1'
					   AND SUBSTR(IVM.DEPT_ID, 1,2) = IC.DEPT_DIV_ID
					   AND IC.COMP_ID = IVM.COMP_ID
					   AND IC.DEPT_DIV_ID = SUBSTR(CD.DEPT_ID, 1, 2) ) AS TODAY_CNT ,
				       (SELECT COUNT(*)
					  FROM IO_VSTCAR_M IVM ,
					       IO_VSTCAR_D IVD ,
					       AP_DOC AD
					 WHERE 1=1
					   AND IVM.VSTCAR_APPL_NO = IVD.VSTCAR_APPL_NO
					   AND AD.DOC_ID = IVM.DOC_ID
					   AND IVM.COMP_ID = '1101000001'
					   AND IVM.VIP_YN != 'Y'
					   AND IO_DT = REPLACE(REPLACE(#{ioDt}, '-', ''), ';', '')
					   AND AD.APPR_STAT = '10'
					   AND AD.APPR_RESULT = '0'
					   AND SUBSTR(IVM.DEPT_ID, 1,2) = IC.DEPT_DIV_ID
					   AND IC.COMP_ID = IVM.COMP_ID
					   AND IC.DEPT_DIV_ID = SUBSTR(CD.DEPT_ID, 1, 2) ) AS TODAY_WAIT_CNT ,
				       (SELECT SUM(CAR_QTA)
					  FROM IO_CARQUOTA
					 WHERE COMP_ID = IC.COMP_ID
					   AND DEL_YN = 'N') AS TOTAL
				  FROM IO_CARQUOTA IC ,
				       CO_DEPT CD
				 WHERE 1=1
				   AND CD.DEPT_DIV_CD = IC.DEPT_DIV_ID
				   AND NVL(IC.DEL_YN, 'Y') != 'Y'
						   AND IC.DEPT_DIV_ID = SUBSTR(#{deptId}, 1,2)
				) TB
			    ) A
			)
		WHERE 1=1
			AND (TODAY_CNT <![CDATA[<=]]> 0 OR TODAY_CNT <![CDATA[<]]> #{carCnt})
	</select> -->

	<update id="updateIoEmpCarInfo" parameterType="hashMap">
		UPDATE IO_EMP a
		   SET
		     a.HP_NO = #{hpNo}
		     ,  a.CAR_KND = #{carKnd}
		     ,  a.CAR_NO = #{carNo}
		     ,  a.MOD_BY = #{modBy}
		     ,  a.MOD_DTM = SYSDATE
		 WHERE a.IO_EMP_ID = #{ioEmpId}
	</update>

</mapper>